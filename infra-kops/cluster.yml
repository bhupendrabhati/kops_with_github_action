apiVersion: kops.k8s.io/v1alpha3
kind: Cluster
metadata:
  name: ${CLUSTER_NAME}           # set via envsubst or CLUSTER_NAME secret/var
spec:
  kubernetesVersion: "1.26.9"
  # cloudProvider must be an object, not a plain string
  cloudProvider:
    name: aws

  configBase: ${KOPS_STATE_STORE}/${CLUSTER_NAME}
  networkCIDR: 10.0.0.0/16

  subnets:
    - name: idp-subnet-private-a
      zone: ap-south-1a
      cidr: 10.0.1.0/24
      type: Private
    - name: idp-subnet-private-b
      zone: ap-south-1b
      cidr: 10.0.2.0/24
      type: Private
    - name: idp-subnet-private-c
      zone: ap-south-1c
      cidr: 10.0.3.0/24
      type: Private

  topology:
    masters: private
    nodes: private
    bastion: public

  sshAccess:
    - 106.219.69.76/32   # replace with your IP/CIDR for production

  nodePortAccess:
    - 0.0.0.0/0

  authorization:
    rbac: {}

  networking:
    calico: {}

  api:
    loadBalancer:
      type: Public
      # For NLB use annotation (kOps will use NLB if you ask)
      annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: "nlb"

  kubeAPIServer:
    enableAdmissionPlugins:
      - NodeRestriction

  etcdClusters:
    - name: main
      spec:
        etcdMembers:
          - name: a
            instanceGroup: master-ap-south-1a
          - name: b
            instanceGroup: master-ap-south-1b
          - name: c
            instanceGroup: master-ap-south-1c

  cloudLabels:
    Environment: dev
    ManagedBy: kops

---
# InstanceGroup: master-ap-south-1a
apiVersion: kops.k8s.io/v1alpha3
kind: InstanceGroup
metadata:
  name: master-ap-south-1a
spec:
  role: Master
  subnets:
    - ap-south-1a
  machineType: t3.medium
  rootVolumeSize: 20
  rootVolumeType: gp3
  minSize: 1
  maxSize: 1

---
# InstanceGroup: master-ap-south-1b
apiVersion: kops.k8s.io/v1alpha3
kind: InstanceGroup
metadata:
  name: master-ap-south-1b
spec:
  role: Master
  subnets:
    - ap-south-1b
  machineType: t3.medium
  rootVolumeSize: 20
  rootVolumeType: gp3
  minSize: 1
  maxSize: 1

---
# InstanceGroup: master-ap-south-1c
apiVersion: kops.k8s.io/v1alpha3
kind: InstanceGroup
metadata:
  name: master-ap-south-1c
spec:
  role: Master
  subnets:
    - ap-south-1c
  machineType: t3.medium
  rootVolumeSize: 20
  rootVolumeType: gp3
  minSize: 1
  maxSize: 1

---
# InstanceGroup: nodes
apiVersion: kops.k8s.io/v1alpha3
kind: InstanceGroup
metadata:
  name: nodes
spec:
  role: Node
  subnets:
    - ap-south-1a
    - ap-south-1b
    - ap-south-1c
  machineType: t3.small
  rootVolumeSize: 20
  rootVolumeType: gp3
  minSize: 2
  maxSize: 4
  additionalUserData:
    - name: 99-disable-aws-metadata
      type: text/x-shellscript
      content: |
        #!/bin/bash
        # additional node bootstrapping commands if needed
